<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Kitties Demo</title>
  <style>
    .viewport { width: 600px; height: 600px; }
    .layer { position: absolute; }
  </style>
</head>
<body>
  <div class="viewport">
    <canvas data-canvas-background class="layer" width="600" height="600"></canvas>
    <canvas data-canvas-entities class="layer" width="600" height="600"></canvas>
  </div>
  <script src="dist/kitties.js"></script>
  <script>
    var Scheduler;
    var spriteAnimation;
    var foo;

    use(['Obj', 'Injector'], function(Obj, Injector) {
      Injector.addInterceptor(/clone (.*)/, function(module) {
        return Obj.clone(module);
      });
    });

    use([
      'Sprite', 
      'Scene',
      'SpriteAnimation',
      'EntityLayer',
      'BackgroundLayer',
      'Scheduler', 
      'ImageLoader',
      'Common',
      'canvas-background',
      'canvas-entities'],
    function(Sprite, Scene, SpriteAnimation, EntityLayer, BackgroundLayer, Scheduler, ImageLoader, Common, canvasBackground, canvasEntities) {
      'use strict';

      var backgroundLayer = BackgroundLayer(canvasBackground);
      var entityLayer = EntityLayer(canvasEntities);

      Scene('assets/kitty-world.json').then(function(scene) {
        console.log(scene);

        var layerDefinitions = scene.layerDefinitions;

        Object.keys(layerDefinitions)
          .map(function(layerId) {
            var backgroundUrl;
            var layerDefinition = layerDefinitions[layerId];

            if(layerDefinition.backgroundUrl) {
              backgroundUrl = (!Common.isFullUrl(layerDefinition.backgroundUrl)) ?
                scene.baseUrl + '/' + layerDefinition.backgroundUrl : layerDefinition.backgroundUrl;

              ImageLoader(backgroundUrl)
                .then(function(image) {
                  backgroundLayer.setBackground(image);
                  Scheduler(function() {
                    backgroundLayer.draw();
                  });
                });
            }

            if(layerDefinition.sprites) {
              Object.keys(layerDefinition.sprites).forEach(function(spriteId) {
                Sprite('assets/kitty.json').then(function(sprite) {
                  if(!sprite) {
                    return;
                  }
                  console.log(sprite);
                  spriteAnimation = SpriteAnimation(sprite).play('run');

                  entityLayer.addEntity(spriteAnimation);
                });
              });                

              Scheduler(function() {
                entityLayer.draw();
              });
            }
          });
      });
    });
  </script>
</body>
</html>