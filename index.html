<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Kitties Demo</title>
  <style>
    .viewport { width: 600px; height: 400px; }
    .layer { position: absolute; }
  </style>
</head>
<body>
  <div class="viewport">
    <canvas data-canvas-background class="layer" width="600" height="400"></canvas>
    <canvas data-canvas-entities class="layer" width="600" height="400"></canvas>
    <canvas data-canvas-colliders class="layer" width="600" height="400"></canvas>
  </div>
  <script src="dist/kitties.js"></script>
  <script>
    use(['Obj', 'Injector'], function(Obj, Injector) {
      Injector.addInterceptor(/clone (.*)/, function(module) {
        return Obj.clone(module);
      });
    });

    use([
      'Util',
      'Sprite', 
      'Scene',
      'SpriteAnimation',
      'EntityLayer',
      'BackgroundLayer',
      'CollisionLayer',
      'Scheduler', 
      'ImageLoader',
      'BackgroundImage',
      'canvas-background',
      'canvas-entities',
      'canvas-colliders',
      ],
    function(Util, Sprite, Scene, SpriteAnimation, EntityLayer, BackgroundLayer, CollisionLayer, Scheduler, ImageLoader, BackgroundImage, canvasBackground, canvasEntities, canvasColliders) {
      'use strict';

      function makeLayers(layerDefinitions, actions) {
        Object.keys(layerDefinitions).forEach(function(actionName) {
          var action = actions[actionName];
          if(Util.isFunction(action)) {
            action(layerDefinitions[actionName]);
          }
        });
      }

      var viewport = {
        x: 0,
        y: 0,
        width: 600,
        height: 400
      };       

      // Setup background layer
      var backgroundLayer = BackgroundLayer(canvasBackground);
      Scheduler(function() {
        backgroundLayer.draw(viewport);
      });

      // Setup entity layer
      var entityLayer = EntityLayer(canvasEntities);
      Scheduler(function() {
        entityLayer.draw(viewport);
      });

      var collisionLayer = CollisionLayer(canvasColliders);

      // Get scene
      Scene('assets/kitty-world.json')
        .then(function(scene) {
          makeLayers(scene.layerDefinitions, {
            background: function (data) {
              BackgroundImage(data.backgroundUrl, scene.baseUrl)
                .then(function(image) {
                  backgroundLayer.setBackground(image);
                });
            },
            entities: function (data) {
              var sprites = data.sprites;

              sprites.forEach(function(sprite) {
                Sprite(sprite.src, scene.baseUrl)
                  .then(function(sprite) {
                    if(!sprite) {
                      return;
                    }
                    sprite.spriteAnimation = SpriteAnimation(sprite).play('run');
                    entityLayer.addEntity(sprite.spriteAnimation);
                  });
              });
            },
            collisions: function(data) {
              collisionLayer.setColliders(data.colliders);
              collisionLayer.draw();
            }
          });
      });
    });
  </script>
</body>
</html>