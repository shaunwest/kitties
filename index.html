<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Kitties Demo</title>
  <style>
    .stage { width: 600px; height: 400px; background-color: #969696; }
    .layer { position: absolute; }
  </style>
</head>
<body>
  <div class="stage">
    <canvas data-canvas-background class="layer" width="600" height="400"></canvas>
    <canvas data-canvas-entities class="layer" width="600" height="400"></canvas>
    <canvas data-canvas-colliders class="layer" width="600" height="400"></canvas>
  </div>
  <script src="dist/kitties.js"></script>
  <script>
    use([
      'Util',
      'Sprite', 
      'Scene',
      'SpriteAnimation',
      'EntityLayer',
      'BackgroundLayer',
      'CollisionLayer',
      'Scheduler', 
      'ImageLoader',
      'BackgroundImage',
      'Common',
      'canvas-background',
      'canvas-entities',
      'canvas-colliders',
      ],
    function(Util, Sprite, Scene, SpriteAnimation, EntityLayer, BackgroundLayer, CollisionLayer, Scheduler, ImageLoader, BackgroundImage, Common, canvasBackground, canvasEntities, canvasColliders) {
      'use strict';

      function makeLayers(layerDefinitions, actions) {
        Object.keys(layerDefinitions).forEach(function(actionName) {
          var action = actions[actionName];
          if(Util.isFunction(action)) {
            action(layerDefinitions[actionName]);
          }
        });
      }

      var viewport = {
        x: 0,
        y: 0,
        width: 600,
        height: 400
      };       

      var entities = [];

      // Setup background layer
      var backgroundLayer = BackgroundLayer(canvasBackground);
      Scheduler(function() {
        backgroundLayer.draw(viewport);
      });

      // Setup entity layer
      var entityLayer = EntityLayer(canvasEntities);
      Scheduler(function() {
        entityLayer.draw(viewport);
      });

      // Setup collision debug layer
      var collisionLayer = CollisionLayer(canvasColliders);
      Scheduler(function() {
        collisionLayer.draw(viewport);
      });

      // Get scene
      Scene('assets/kitty-world.json')
        .then(function(scene) {
          makeLayers(scene.layerDefinitions, { 
            background: function (data) {
              var fullUrl = Common.normalizeUrl(data.backgroundUrl, scene.baseUrl);
              BackgroundImage(fullUrl)
                .then(function(image) {
                  backgroundLayer.setBackground(image);
                });
            },
            entities: function (data) {
              data.sprites.forEach(function(spriteData) {
                Sprite(spriteData, scene.baseUrl)
                  .then(function(sprite) {
                    sprite.animation = SpriteAnimation(sprite.definition)
                      .play('run');

                    entityLayer.addEntity(sprite);
                    entities.push(sprite);
                  });
              });

              collisionLayer.setEntities(entities);
            },
            collisions: function(data) {
              collisionLayer.setColliders(data.colliders);
            }
          });
      });
    });
  </script>
</body>
</html>